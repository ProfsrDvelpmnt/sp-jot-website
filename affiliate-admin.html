<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-7M9PMK2FNN"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-7M9PMK2FNN');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="facebook-domain-verification" content="0k8dgkmdck3q6bcdaz0a8e0dnav89e" />
    <title>Affiliate Admin Panel - SavvyPro JOTâ„¢</title>
    <link rel="icon" type="image/png" href="images/spjot-48.png">
    <link rel="shortcut icon" type="image/png" href="images/spjot-48.png">
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Inter', sans-serif;
        }
        
        .admin-container {
            min-height: 100vh;
            padding-top: 2rem;
        }
        
        .admin-panel {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .admin-header {
            text-align: center;
            margin-bottom: 2rem;
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .admin-header h1 {
            color: #333;
            margin-bottom: 0.5rem;
        }
        
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #421237;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        .applications-table {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .table-header {
            background: #421237;
            color: white;
            padding: 1rem;
            font-weight: bold;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr auto;
            gap: 1rem;
        }
        
        .table-content {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .application-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr auto;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid #eee;
            align-items: center;
        }
        
        .application-row:hover {
            background-color: #f8f9fa;
        }
        
        .application-row:last-child {
            border-bottom: none;
        }
        
        .app-info {
            font-size: 0.9rem;
        }
        
        .app-info strong {
            display: block;
            margin-bottom: 0.25rem;
            color: #333;
        }
        
        .app-info span {
            color: #666;
        }
        
        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-approve {
            background: #28a745;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .btn-deny {
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .btn-approve:hover {
            background: #218838;
        }
        
        .btn-deny:hover {
            background: #c82333;
        }
        
        .no-applications {
            text-align: center;
            padding: 2rem;
            color: #666;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 2rem;
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: black;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
        }
        
        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1rem;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .btn-primary {
            background: #421237;
            color: white;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        @media (max-width: 768px) {
            .admin-panel {
                padding: 1rem;
            }
            
            .application-row {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            .table-header {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-panel">
            <div class="admin-header">
                <h1><i class="fas fa-users-cog"></i> Affiliate Admin Panel</h1>
                <p>Manage affiliate applications and approvals</p>
                <button class="btn btn-primary" onclick="loadApplications()" style="margin-top: 1rem;">
                    <i class="fas fa-sync-alt"></i> Refresh Applications
                </button>
                <button class="btn btn-secondary" onclick="testGoogleScript()" style="margin-top: 0.5rem; margin-left: 0.5rem;">
                    <i class="fas fa-vial"></i> Test Google Script
                </button>
            </div>
            
            <div class="admin-stats">
                <div class="stat-card">
                    <div class="stat-number" id="pendingCount">0</div>
                    <div class="stat-label">Pending Applications</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="approvedCount">0</div>
                    <div class="stat-label">Approved</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="deniedCount">0</div>
                    <div class="stat-label">Denied</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalCount">0</div>
                    <div class="stat-label">Total Applications</div>
                </div>
            </div>
            
            <div class="applications-table">
                <div class="table-header">
                    <div>Applicant</div>
                    <div>Contact</div>
                    <div>Platform</div>
                    <div>Experience</div>
                    <div>Actions</div>
                </div>
                <div class="table-content" id="applicationsList">
                    <div class="no-applications">
                        <i class="fas fa-spinner fa-spin"></i> Loading applications...
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Approval Modal -->
    <div id="approvalModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Approve Application</h3>
                <span class="close" onclick="closeModal('approvalModal')">&times;</span>
            </div>
            <div class="form-group">
                <label for="approvalNotes">Admin Notes (Optional)</label>
                <textarea id="approvalNotes" rows="3" placeholder="Add any notes about this approval..."></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('approvalModal')">Cancel</button>
                <button class="btn btn-primary" onclick="confirmApproval()">Approve</button>
            </div>
        </div>
    </div>
    
    <!-- Denial Modal -->
    <div id="denialModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Deny Application</h3>
                <span class="close" onclick="closeModal('denialModal')">&times;</span>
            </div>
            <div class="form-group">
                <label for="denialReason">Reason for Denial</label>
                <textarea id="denialReason" rows="3" placeholder="Please provide a reason for denial..." required></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('denialModal')">Cancel</button>
                <button class="btn btn-primary" onclick="confirmDenial()">Deny</button>
            </div>
        </div>
    </div>
    
    <script>
        // Configuration - Update with your actual Google Apps Script URL
        const CONFIG = {
            GOOGLE_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbwUKxUiDunKO_n_M-wNEHIoDUgtrXa9Rupc327mo-lDmONf0qWC50P0N2uJnOVnRYMl/exec', // Replace with your new deployment URL
        };
        
        let currentApplicationId = null;
        let applications = [];
        
        // Load applications on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadApplications();
        });
        
        // Load applications from Google Sheets
        async function loadApplications() {
            try {
                console.log('Loading applications from Google Sheets...');
                
                // Try to fetch from Google Apps Script
                const response = await fetch(`${CONFIG.GOOGLE_SCRIPT_URL}?action=getApplications`, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                
                if (response.ok) {
                    const responseText = await response.text();
                    console.log('Raw response:', responseText);
                    
                    try {
                        const result = JSON.parse(responseText);
                        console.log('Parsed result:', result);
                        
                        if (result.success && result.applications) {
                            applications = result.applications;
                            console.log('Loaded applications from Google Sheets:', applications.length);
                        } else {
                            console.log('No applications found or error in response:', result);
                            applications = [];
                        }
                    } catch (parseError) {
                        console.error('Error parsing response:', parseError);
                        console.log('Response text:', responseText);
                        applications = [];
                    }
                } else {
                    console.log('Failed to fetch from Google Sheets, using fallback');
                    console.log('Response status:', response.status);
                    // Fallback to mock data if Google Sheets fetch fails
                    applications = getMockApplications();
                }
                
                updateStats();
                renderApplications();
                
            } catch (error) {
                console.error('Error loading applications:', error);
                console.log('Using fallback mock data');
                
                // Fallback to mock data
                applications = getMockApplications();
                updateStats();
                renderApplications();
            }
        }
        
        // Mock data fallback
        function getMockApplications() {
            return [
                {
                    applicationId: 'APP-12345678',
                    firstName: 'John',
                    lastName: 'Doe',
                    email: 'john@example.com',
                    website: 'https://johndoe.com',
                    socialMedia: 'linkedin-1k-10k',
                    referralSource: 'google',
                    experience: 'intermediate',
                    promotionMethods: 'Blog posts and social media marketing',
                    monthlyTraffic: '1k-10k',
                    marketingConsent: true,
                    timestamp: new Date('2024-01-15'),
                    status: 'Pending'
                },
                {
                    applicationId: 'APP-87654321',
                    firstName: 'Jane',
                    lastName: 'Smith',
                    email: 'jane@example.com',
                    website: 'https://janesmith.com',
                    socialMedia: 'instagram-10k+',
                    referralSource: 'social-media',
                    experience: 'advanced',
                    promotionMethods: 'Instagram posts and stories',
                    monthlyTraffic: '10k-50k',
                    marketingConsent: true,
                    timestamp: new Date('2024-01-14'),
                    status: 'Pending'
                }
            ];
        }
        
        // Update statistics
        function updateStats() {
            const pending = applications.filter(app => app.status === 'Pending').length;
            const approved = applications.filter(app => app.status === 'Approved').length;
            const denied = applications.filter(app => app.status === 'Denied').length;
            const total = applications.length;
            
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('approvedCount').textContent = approved;
            document.getElementById('deniedCount').textContent = denied;
            document.getElementById('totalCount').textContent = total;
        }
        
        // Render applications list
        function renderApplications() {
            const container = document.getElementById('applicationsList');
            
            if (applications.length === 0) {
                container.innerHTML = '<div class="no-applications">No applications found.</div>';
                return;
            }
            
            // Show all applications, not just pending
            const allApps = applications;
            
            if (allApps.length === 0) {
                container.innerHTML = '<div class="no-applications">No applications found.</div>';
                return;
            }
            
            container.innerHTML = allApps.map(app => `
                <div class="application-row">
                    <div class="app-info">
                        <strong>${app.firstName} ${app.lastName}</strong>
                        <span>ID: ${app.applicationId}</span>
                    </div>
                    <div class="app-info">
                        <strong>${app.email}</strong>
                        <span>${app.website || 'No website'}</span>
                    </div>
                    <div class="app-info">
                        <strong>${formatSocialMedia(app.socialMedia)}</strong>
                        <span>${formatTraffic(app.monthlyTraffic)}</span>
                    </div>
                    <div class="app-info">
                        <strong>${formatExperience(app.experience)}</strong>
                        <span>${formatReferralSource(app.referralSource)}</span>
                    </div>
                    <div class="app-info">
                        <strong>Status: ${app.status}</strong>
                        <span>${new Date(app.timestamp).toLocaleDateString()}</span>
                    </div>
                    <div class="action-buttons">
                        ${app.status === 'Pending' ? `
                            <button class="btn-approve" onclick="approveApplication('${app.applicationId}')">
                                <i class="fas fa-check"></i> Approve
                            </button>
                            <button class="btn-deny" onclick="denyApplication('${app.applicationId}')">
                                <i class="fas fa-times"></i> Deny
                            </button>
                        ` : `
                            <span class="status-badge ${app.status.toLowerCase()}">${app.status}</span>
                        `}
                    </div>
                </div>
            `).join('');
        }
        
        // Format social media info
        function formatSocialMedia(socialMedia) {
            const platformMap = {
                'linkedin': 'LinkedIn',
                'linkedin-1k-10k': 'LinkedIn (1K-10K)',
                'linkedin-10k+': 'LinkedIn (10K+)',
                'twitter': 'X',
                'twitter-1k-10k': 'X (1K-10K)',
                'twitter-10k+': 'X (10K+)',
                'instagram': 'Instagram',
                'instagram-1k-10k': 'Instagram (1K-10K)',
                'instagram-10k+': 'Instagram (10K+)',
                'youtube': 'YouTube',
                'youtube-1k-10k': 'YouTube (1K-10K)',
                'youtube-10k+': 'YouTube (10K+)',
                'other': 'Other'
            };
            return platformMap[socialMedia] || socialMedia;
        }
        
        // Format traffic info
        function formatTraffic(traffic) {
            const trafficMap = {
                '0-1k': '0-1K visitors',
                '1k-10k': '1K-10K visitors',
                '10k-50k': '10K-50K visitors',
                '50k-100k': '50K-100K visitors',
                '100k+': '100K+ visitors'
            };
            return trafficMap[traffic] || traffic;
        }
        
        // Format experience
        function formatExperience(experience) {
            const experienceMap = {
                'beginner': 'Beginner',
                'intermediate': 'Intermediate',
                'advanced': 'Advanced',
                'expert': 'Expert'
            };
            return experienceMap[experience] || experience;
        }
        
        // Format referral source
        function formatReferralSource(source) {
            const sourceMap = {
                'google': 'Google Search',
                'social-media': 'Social Media',
                'friend': 'Friend/Colleague',
                'blog': 'Blog/Website',
                'podcast': 'Podcast',
                'other': 'Other'
            };
            return sourceMap[source] || source;
        }
        
        // Approve application
        function approveApplication(applicationId) {
            currentApplicationId = applicationId;
            document.getElementById('approvalModal').style.display = 'block';
        }
        
        // Deny application
        function denyApplication(applicationId) {
            currentApplicationId = applicationId;
            document.getElementById('denialModal').style.display = 'block';
        }
        
        // Confirm approval
        async function confirmApproval() {
            const notes = document.getElementById('approvalNotes').value;
            
            try {
                console.log('Approving application:', currentApplicationId);
                console.log('Notes:', notes);
                
                // Call Google Apps Script to approve
                const response = await fetch(`${CONFIG.GOOGLE_SCRIPT_URL}?action=approve&id=${currentApplicationId}&notes=${encodeURIComponent(notes)}`, {
                    method: 'GET',
                    mode: 'no-cors'
                });
                
                console.log('Approval request sent successfully');
                
                // With no-cors mode, we can't read the response, so we'll assume success
                // and reload the applications to verify
                setTimeout(async () => {
                    try {
                        await loadApplications();
                        closeModal('approvalModal');
                        alert('Application approved successfully!');
                    } catch (error) {
                        console.error('Error reloading applications:', error);
                        alert('Application may have been approved. Please refresh the page to verify.');
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Error approving application:', error);
                alert('Error approving application. Please try again.');
            }
        }
        
        // Confirm denial
        async function confirmDenial() {
            const reason = document.getElementById('denialReason').value;
            
            if (!reason.trim()) {
                alert('Please provide a reason for denial.');
                return;
            }
            
            try {
                console.log('Denying application:', currentApplicationId);
                console.log('Reason:', reason);
                
                // Call Google Apps Script to deny
                const response = await fetch(`${CONFIG.GOOGLE_SCRIPT_URL}?action=deny&id=${currentApplicationId}&reason=${encodeURIComponent(reason)}`, {
                    method: 'GET',
                    mode: 'no-cors'
                });
                
                console.log('Denial request sent successfully');
                
                // With no-cors mode, we can't read the response, so we'll assume success
                // and reload the applications to verify
                setTimeout(async () => {
                    try {
                        await loadApplications();
                        closeModal('denialModal');
                        alert('Application denied.');
                    } catch (error) {
                        console.error('Error reloading applications:', error);
                        alert('Application may have been denied. Please refresh the page to verify.');
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Error denying application:', error);
                alert('Error denying application. Please try again.');
            }
        }
        
        // Close modal
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            document.getElementById('approvalNotes').value = '';
            document.getElementById('denialReason').value = '';
            currentApplicationId = null;
        }
        
        // Test Google Script connection
        async function testGoogleScript() {
            try {
                console.log('Testing Google Script connection...');
                console.log('Script URL:', CONFIG.GOOGLE_SCRIPT_URL);
                
                const response = await fetch(`${CONFIG.GOOGLE_SCRIPT_URL}?action=test`, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                console.log('Test response status:', response.status);
                console.log('Test response ok:', response.ok);
                
                const responseText = await response.text();
                console.log('Test response text:', responseText);
                
                try {
                    const result = JSON.parse(responseText);
                    console.log('Test parsed result:', result);
                    alert('Google Script test successful! Check console for details.');
                } catch (parseError) {
                    console.error('Error parsing test response:', parseError);
                    alert('Google Script responded but with invalid JSON. Check console for details.');
                }
                
            } catch (error) {
                console.error('Google Script test failed:', error);
                alert('Google Script test failed. Check console for details.');
            }
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const approvalModal = document.getElementById('approvalModal');
            const denialModal = document.getElementById('denialModal');
            
            if (event.target === approvalModal) {
                closeModal('approvalModal');
            }
            if (event.target === denialModal) {
                closeModal('denialModal');
            }
        }
    </script>
</body>
</html>
